@inherits Nancy.ViewEngines.Razor.NancyRazorViewBase<dynamic>
@using Nancy.Validation;
@using Bilin3d.HtmlExtensions;
@using System.Collections.Generic;

@{
    Layout = "_Layout.cshtml";
}

@section Css{
    <link href="//cdn.bootcss.com/jqueryui/1.12.0/jquery-ui.min.css" rel="stylesheet">    
    <style>        
        .content {
            padding-top: 20px;           
        }

        .list-group > li.active, .list-group > li.active:hover {
            background: none;
        }

        .list-group > li > a:hover,
        .list-group > li.active > a {
            color: #72c02c !important;
            font-weight: bold;
        }

        .list-group li a {
            color: #666;
            font-size: 14px;
            padding: 12px 10px;
        }

        .list-group .active > a,
        .list-group li > a:focus,
        .list-group li > a:hover {
            filter: none !important;
            color: #72c02c !important;
            background: inherit !important;
        }

        #printerlist .id{display:none;}
        #printerlist .fname{font-size:22px;font-weight:bold;cursor:pointer;}
        .pbody{display:none;}
    </style>
}

@section Javascript{   
    <script src="//cdn.bootcss.com/jqueryui/1.12.0/jquery-ui.min.js"></script>
    <script src="/hub/printer.js"></script>
    <script src="/hub/material.js"></script>
    <script>
        $(function () {            
            $("#printer").autocomplete({
                minLength: 0,
                source: printers,
                focus: function (event, ui) {
                    $("#printer").val(ui.item.label);
                    return false;
                },
                select: function (event, ui) {
                    $("#printerid").val(ui.item.value);
                    $("#printer").val(ui.item.label);
                    $("#addprinter").removeAttr("disabled");
                    return false;
                }
            }).autocomplete("instance")._renderItem = function (ul, item) {
                return $("<li>")
                  .append("<div>" + item.label + "</div>")
                  .appendTo(ul);
            };
          
            $(document).on('focus', ".materialtxt", function () {
                $(this).autocomplete({
                    minLength: 0,
                    source: materials,
                    focus: function (event, ui) {
                        $(this).val(ui.item.label);
                        return false;
                    },
                    select: function (event, ui) {
                        $(this).prev(".materialid").val(ui.item.value);
                        $(this).val(ui.item.label);
                        $(this).next(".addmaterial").removeAttr("disabled");
                        return false;
                    }
                }).autocomplete("instance")._renderItem = function (ul, item) {
                    return $("<li>")
                      .append("<div>" + item.label + "</div>")
                      .appendTo(ul);
                };
            });                     

            var GetPrinters = function () {
                $.ajax({
                    url: '/hub/printer/material/list',
                    type: 'GET',
                    success: function (data) {
                        var str = "";
                        $.each(data, function (index, item) {
                            str += "<div class='panel panel-grey equal-height-column'>"
                                        + "<div class='panel-heading'>"
                                        + "   <h3 class='panel-title fname'>" + item["fname"] + "<span class='id'>" + item["iD"] + "</span></h3>"
                                        + "</div>"
                                        + "<div class='panel-body pbody'>"
                                        + "   <h4>打印材料</h4>"
                                        + "   <ul class='material-list'></ul>"
                                        + "   <h6>添加打印材料</h6>"
                                        + "   <input type='hidden' class='materialid' value='' />"
                                        + "   <input type='text' class='materialtxt' value='' style='height:34px;width:550px;padding-left:6px;' placeholder='打印材料名称' />"
                                        + "   <button type='button' class='btn btn-u addmaterial' style='font-size:14px;' disabled='disabled'>添加材料</button>"
                                        + "   <a href=''>找不到材料？请告诉我们!</a>"
                                        + "</div>"
                                  + "</div>";
                        });
                        $("#printerlist").html(str);
                    },
                    error: function (data) {
                        alert(data);
                    }
                });
            };
            GetPrinters();

            $("#addprinter").click(function () {
                var printerid =$("#printerid").val();
                $.ajax({
                    url: '/hub/printer/add',
                    data: { printerid : printerid},
                    type: 'POST',
                    success: function (data) {
                        GetPrinters();
                    },
                    error: function (data) {
                        if (data.status == "400") {
                            alert(data.responseJSON.message);
                        }                       
                    }
                });
            });

            $(document).on("click", ".fname", function () {
                $(this).parent().next(".pbody").toggle();
            });

            $(document).on("click", ".addmaterial", function () {              
                var materialid = $(this).prevAll(".materialid").val();
                alert(materialid);
                //return;
                $.ajax({
                    url: '/hub/printer/material/add',
                    data: {
                        printerid: printerid,
                        materialid: materialid,
                        completeid: completeid,
                        accuracyid: accuracyid,
                        price: price
                    },
                    type: 'POST',
                    success: function (data) {
                        alert("添加成功!");
                        //GetPrinters();
                    },
                    error: function (data) {
                        if (data.status == "400") {
                            alert(data.responseJSON.message);
                        }
                    }
                });
            });

        });
    </script>
}

<div class="row">
    <!-- 左边菜单-->
    @Html.Partial("_Hub.cshtml")
    <!-- 左边菜单 -->
    
    <!-- Begin Content -->
    <div class="col-md-9">
        <div><h2>打印机</h2></div>
        
        <div id="printerlist">            
        </div>

        <div class="panel-body">
            <h4>添加打印机</h4>
            <input type="hidden" id="printerid" value="" />
            <input type="text" id="printer" value="" style="height:34px;width:550px;padding-left:6px;" placeholder="打印机名称" />
            <button type="button" id="addprinter" class="btn btn-u" style="font-size:14px;" disabled="disabled">添加打印机</button>
            <a href="/">找不到打印机？请告诉我们!</a>
        </div>

        <div class="margin-bottom-40"></div>

    </div>
    <!-- End Content -->
</div>